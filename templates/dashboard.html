<!DOCTYPE html>
<html>

<head>
    <title>GNPS Metadata Analysis Interface</title>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</head>

<body>
    <!-- A grey horizontal navbar that becomes vertical on small screens -->
    <nav class="navbar navbar-expand-sm bg-light navbar-light">
        <a class="navbar-brand" href="gnps.ucsd.edu">
            <img src="/static/img/GNPS_logo.png" alt="Logo" style="width:120px;">
        </a>

      <!-- Links -->
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="/dashboard">Analysis Selection</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/metadata">Metadata Explorer</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://bix-lab.ucsd.edu/display/Public/GNPS+Documentation+Page">Documentation</a>
        </li>
      </ul>

    </nav>

    <div id="app-4" class="col-md-8 justify-content-center align-items-center">
        <h1>GNPS Metadata Analysis Interface</h1>

        <div id="toppanel" class="row">
            <div class="col">
                <h2>Analysis Summary</h2>
                <analysis-gobutton></analysis-gobutton>
            </div>

            <div class="col">
                <h2>Attributes</h2>
                <attribute-viewer v-for="item in attributes" v-bind:attributename="item.attributename" v-on:update-attribute="updateAttributeSelection"></attribute-viewer>
            </div>
        </div>

        <div>
            <h2>Attribute Terms</h2>
            <table class="table table-sm table-striped">
                <thead>
                  <tr>
                    <th>Attribute</th>
                    <th>Term</th>
                    <th># Files</th>
                    <th>Analyze Selection</th>
                  </tr>
                </thead>
                <tbody>
                    <tr v-for="attributeterm in attributeterms">
                        <td>{{attributeterm.attributename}}</td>
                        <td>{{attributeterm.attributeterm}}</td>
                        <td>{{attributeterm.countfiles}}</td>
                        <td><attributeterm-viewer :attributeterm=attributeterm.attributeterm :countfiles=attributeterm.countfiles :attributename=attributeterm.attributename v-on:update-attributeterm="updateAttributeTermSelection"></attributeterm-viewer></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        function generateGNPSfilestring(fileslist) {
            filelist1_array = extractFilenamesToList(fileslist)
            filelist_string = filelist1_array.join(";")

            return filelist_string
        }

        function extractFilenamesToList(fileslist){
            filelist1_array = []
            fileslist.forEach(function(element) {
                filelist1_array.push(element["filename"])
            })
            return filelist1_array
        }

        Vue.component('attribute-viewer', {
            props: ['attributename'],
            data: function() {
                return {
                    count: 0
                }
            },
            methods: {
                clickMe: function(event) {
                    $.ajax({
                        url: "/attribute/" + this.$props["attributename"] + "/attributeterms",
                        success: function(componentObject) {
                            return function(response) {
                                componentObject.$emit("update-attribute", response)
                            }
                        }(this),
                        dataType: "json"
                    });
                }
            },
            template: '<div><button class="btn btn-warning" v-on:click="clickMe">{{attributename}}</button></div>'
        })

        Vue.component('attributeterm-viewer', {
            props: ['attributename', 'attributeterm', 'countfiles'],
            data: function() {
                return {
                    count: 0
                }
            },
            methods: {
                clickMe: function(filelistname) {
                    console.log(filelistname)
                    $.ajax({
                        url: "/attribute/" + this.$props["attributename"] + "/attributeterm/" + this.$props["attributeterm"] + "/files",
                        success: function(componentObject, message) {
                            return function(response) {
                                componentObject.$emit("update-attributeterm", response, filelistname)
                            }
                        }(this, filelistname),
                        dataType: "json"
                    });
                }
            },
            template: '<div> \
                  <button class="btn-sm btn-outline-secondary" v-on:click="clickMe(\'filelist1\')">+G1 </button> \
                  <button class="btn-sm btn-outline-secondary" v-on:click="clickMe(\'filelist2\')">+G2 </button> \
                  <button class="btn-sm btn-outline-secondary" v-on:click="clickMe(\'filelist3\')">+G3 </button> \
                  <button class="btn-sm btn-outline-secondary" v-on:click="clickMe(\'filelist4\')">+G4 </button> \
                  <button class="btn-sm btn-outline-secondary" v-on:click="clickMe(\'filelist5\')">+G5 </button> \
                  <button class="btn-sm btn-outline-secondary" v-on:click="clickMe(\'filelist6\')">+G6 </button> \
                  </div>'
        })

        Vue.component('analysis-gobutton', {
            data: function() {
                return {}
            },
            methods: {
                clickMe: function(event) {
                    //Checking there are no file intersections
                    total_number_of_files = this.$parent.filelist1.length + this.$parent.filelist2.length + this.$parent.filelist3.length + this.$parent.filelist4.length + this.$parent.filelist5.length + this.$parent.filelist6.length
                    unique_list_files = extractFilenamesToList(this.$parent.filelist1.concat(this.$parent.filelist2, this.$parent.filelist3, this.$parent.filelist4, this.$parent.filelist5, this.$parent.filelist6));
                    unique_list_files = Array.from(new Set(unique_list_files));
                    if(total_number_of_files != unique_list_files.length){
                        alert("Warning: some files belong to multiple groups! Might cause some issues on GNPS")
                    }

                    //Forming parameters
                    params_dict = {};
                    params_dict["desc"] = "Meta-Analysis on GNPS"
                    params_dict["workflow"] = "METABOLOMICS-SNETS-V2"
                    params_dict["library_on_server"] = "d.speclibs;"
                    params_dict["spec_on_server"] = generateGNPSfilestring(this.$parent.filelist1)
                    params_dict["spec_on_server_group2"] = generateGNPSfilestring(this.$parent.filelist2)
                    params_dict["spec_on_server_group3"] = generateGNPSfilestring(this.$parent.filelist3)
                    params_dict["spec_on_server_group4"] = generateGNPSfilestring(this.$parent.filelist4)
                    params_dict["spec_on_server_group5"] = generateGNPSfilestring(this.$parent.filelist5)
                    params_dict["spec_on_server_group6"] = generateGNPSfilestring(this.$parent.filelist6)

                    //analysis_url = "https://ccms-internal.ucsd.edu/ProteoSAFe/index.jsp?#" + encodeURIComponent(JSON.stringify(params_dict))
                    analysis_url = "https://gnps.ucsd.edu/ProteoSAFe/index.jsp?#" + encodeURIComponent(JSON.stringify(params_dict))
                    var win = window.open(analysis_url, '_blank');
                    win.focus();
                }
            },
            template: '<div> \
      Group 1 {{ this.$parent.filelist1.length }} Files <br> \
      Group 2 {{ this.$parent.filelist2.length }} Files <br> \
      Group 3 {{ this.$parent.filelist3.length }} Files <br> \
      Group 4 {{ this.$parent.filelist4.length }} Files <br> \
      Group 5 {{ this.$parent.filelist5.length }} Files <br> \
      Group 6 {{ this.$parent.filelist6.length }} Files <br> \
      <button class="btn btn-primary" v-on:click="clickMe">Analyze Data on GNPS Networking</button> \
      </div>'
        })

        var app4 = new Vue({
            el: '#app-4',
            methods: {
                updateAttributeSelection: function(attributeterm_list) {
                    this.attributeterms = attributeterm_list
                },
                updateAttributeTermSelection: function(filelist, filelistname) {
                    this[filelistname] = filelist
                    console.log("TOP", filelistname)
                }
            },
            data: {
                attributes: [{
                    attributename: "ATTRIBUTE_1"
                }, {
                    attributename: "ATTRIBUTE_2"
                }],
                attributeterms: [{
                    attributename: "ATTRIBUTE_1",
                    attributeterm: "term1",
                    countfiles: "0"
                }],
                filelist1: [],
                filelist2: [],
                filelist3: [],
                filelist4: [],
                filelist5: [],
                filelist6: []
            }
        })

        //Loading the initial attributes
        $.ajax({
            url: "/attributes",
            success: function(response) {
                app4.attributes = response
            },
            dataType: "json"
        });
    </script>
</body>

</html>
